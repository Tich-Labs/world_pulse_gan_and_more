<% content_for :title, "Chat with #{@other_user.name} - Mentorship Matchmaker" %>

<div class="container mx-auto py-8 px-4 h-screen flex flex-col">
  <div class="flex-1 flex flex-col bg-white rounded-lg shadow overflow-hidden">
    <!-- Header -->
    <div class="p-4 border-b flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 rounded-full bg-primary-custom flex items-center justify-center text-white font-bold">
          <%= @other_user.name.first.upcase %>
        </div>
        <div>
          <h2 class="font-semibold"><%= @other_user.name %></h2>
          <p class="text-xs text-gray-500"><%= current_user.side_label(@conversation.match.match_type) rescue 'Chat' %></p>
        </div>
      </div>
      <%= link_to "View Profile", profile_path(@other_user), class: "btn-secondary-custom text-sm" %>
    </div>

    <!-- Messages -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messages-container" data-conversation-id="<%= @conversation.id %>">
      <% @conversation.messages.order(created_at: :asc).each do |message| %>
        <div class="flex <%= message.sender == current_user ? 'justify-end' : 'justify-start' %>">
          <div class="max-w-xs md:max-w-md <%= message.sender == current_user ? 'bg-primary-custom text-white' : 'bg-gray-100' %> rounded-lg px-4 py-2">
            <p><%= message.content %></p>
            <p class="text-xs <%= message.sender == current_user ? 'text-white/70' : 'text-gray-500' %> mt-1">
              <%= message.created_at.strftime('%h %d, %l:%M %p') %>
            </p>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Message Input -->
    <div class="p-4 border-t">
      <form id="message-form" class="flex gap-2">
        <input type="hidden" id="conversation-id" value="<%= @conversation.id %>">
        <input type="text" id="message-content" 
               placeholder="Type a message..." 
               class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-primary-custom focus:ring-primary-custom"
               autocomplete="off">
        <button type="submit" class="btn-primary-custom">
          Send
        </button>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const container = document.getElementById('messages-container');
  container.scrollTop = container.scrollHeight;

  const form = document.getElementById('message-form');
  const input = document.getElementById('message-content');
  const conversationId = document.getElementById('conversation-id').value;

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    const content = input.value.trim();
    if (!content) return;

    App.chat.sendMessage({
      conversation_id: conversationId,
      content: content
    });

    input.value = '';
  });

  if (App.cable) {
    App.cable.subscriptions.create("ChatChannel", {
      channel: "ChatChannel",
      conversation_id: conversationId
    }, {
      received: function(data) {
        if (data.conversation_id == conversationId) {
          const div = document.createElement('div');
          div.innerHTML = data.message;
          container.appendChild(div);
          container.scrollTop = container.scrollHeight;
        }
      }
    });
  }
});
</script>

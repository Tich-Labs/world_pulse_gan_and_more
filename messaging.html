<!DOCTYPE html>
<html lang="en" data-theme="worldpulse">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="World Pulse Plus Messaging - Connect with advisors and track your advice conversations">
    <title>Messaging - World Pulse Plus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="./css/custom.css">
</head>
<body class="bg-base-100 flex flex-col min-h-screen">
    <!-- Shared Navigation -->
    <div id="shared-navbar"></div>

    <!-- Messaging Page -->
    <div class="flex-1 flex bg-base-200">
        <!-- Sidebar with contacts/conversations -->
        <div class="w-1/3 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <h1 class="text-2xl font-bold text-primary">Messages</h1>
                <p class="text-muted text-sm">Your advice conversations</p>
            </div>
            
            <div class="p-4">
                <input type="text" placeholder="Search conversations..." class="input-custom w-full" id="search-conversations">
            </div>
            
            <div class="flex-1 overflow-y-auto" id="conversations-list">
                <!-- Conversations will be loaded here -->
                <div class="text-center py-8 text-muted">
                    <p>No conversations yet</p>
                    <p class="text-sm mt-2">Connect with advisors to start a conversation</p>
                </div>
            </div>
        </div>
        
        <!-- Chat area -->
        <div class="flex-1 flex flex-col">
            <!-- Chat header -->
            <div class="bg-white border-b border-gray-200 p-4 flex items-center gap-3" id="chat-header">
                <div class="avatar">
                    <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center" id="chat-avatar">
                        <span class="text-primary font-bold" id="chat-avatar-letter">U</span>
                    </div>
                </div>
                <div>
                    <h2 class="font-bold text-primary" id="contact-name">Select a conversation</h2>
                    <p class="text-xs text-muted" id="contact-status">Online</p>
                </div>
            </div>
            
            <!-- Messages area -->
            <div class="flex-1 overflow-y-auto p-4 bg-gray-50" id="messages-container">
                <div class="text-center py-8 text-muted">
                    <p>Select a conversation to start chatting</p>
                    <p class="text-sm mt-2">Your advice conversations will appear here</p>
                </div>
            </div>
            
            <!-- Message input -->
            <div class="bg-white border-t border-gray-200 p-4" id="message-input-area">
                <div class="flex gap-2">
                    <input type="text" placeholder="Type your message..." class="input-custom flex-1" id="message-input" disabled>
                    <button class="btn btn-primary-custom" id="send-message-btn" disabled>Send</button>
                </div>
            </div>
        </div>
    </div>

    <div id="shared-footer"></div>
    <script src="js/load-navbar.js"></script>
    <script src="js/load-footer.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Initialize messaging when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadConversations();
            
            // Set up send message functionality
            document.getElementById('send-message-btn').addEventListener('click', sendMessage);
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
        
        // Load conversations from localStorage
        function loadConversations() {
            const conversationsList = document.getElementById('conversations-list');
            const conversations = JSON.parse(localStorage.getItem('worldpulse_conversations') || '[]');
            
            if (conversations.length === 0) {
                conversationsList.innerHTML = `
                    <div class="text-center py-8 text-muted">
                        <p>No conversations yet</p>
                        <p class="text-sm mt-2">Connect with advisors to start a conversation</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            conversations.forEach(conversation => {
                const lastMessage = conversation.messages[conversation.messages.length - 1] || {text: 'No messages yet', timestamp: new Date().toISOString()};
                html += `
                    <div class="p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50 conversation-item" data-contact-id="${conversation.contactId}">
                        <div class="flex items-center gap-3">
                            <div class="avatar">
                                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                                    <span class="text-primary font-bold">${conversation.contactName.charAt(0)}</span>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-center">
                                    <h3 class="font-bold text-primary truncate">${conversation.contactName}</h3>
                                    <span class="text-xs text-muted">${formatTime(lastMessage.timestamp)}</span>
                                </div>
                                <p class="text-sm text-muted truncate">${lastMessage.text}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            conversationsList.innerHTML = html;
            
            // Add event listeners to conversation items
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', function() {
                    const contactId = this.getAttribute('data-contact-id');
                    loadConversation(contactId);
                });
            });
        }
        
        // Load a specific conversation
        function loadConversation(contactId) {
            const conversations = JSON.parse(localStorage.getItem('worldpulse_conversations') || '[]');
            const conversation = conversations.find(c => c.contactId === contactId);
            
            if (!conversation) return;
            
            // Update chat header
            document.getElementById('contact-name').textContent = conversation.contactName;
            // Update header avatar initial
            const avatarLetterEl = document.getElementById('chat-avatar-letter');
            if (avatarLetterEl) avatarLetterEl.textContent = conversation.contactName.charAt(0);
            
            // Load messages
            const messagesContainer = document.getElementById('messages-container');
            let html = '';
            
            conversation.messages.forEach(message => {
                const isCurrentUser = message.senderId === (window.appData?.currentUser?.id || 'current_user');
                const messageClass = isCurrentUser ? 'justify-end' : 'justify-start';
                const bubbleClass = isCurrentUser ? 'bg-primary text-white' : 'bg-white border border-gray-200';
                
                html += `
                    <div class="flex ${messageClass} mb-4">
                        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${bubbleClass}">
                            <p>${message.text}</p>
                            <p class="text-xs opacity-70 mt-1">${formatTime(message.timestamp)}</p>
                        </div>
                    </div>
                `;
            });
            
            messagesContainer.innerHTML = html;
            
            // Enable message input
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-message-btn').disabled = false;
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Store current conversation
            window.currentConversation = conversation;
        }
        
        // Send a message
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();
            
            if (!messageText || !window.currentConversation) return;
            
            // Create message object
            const message = {
                id: Date.now(),
                text: messageText,
                senderId: window.appData?.currentUser?.id || 'current_user',
                senderName: window.appData?.currentUser?.name || 'Current User',
                timestamp: new Date().toISOString()
            };
            
            // Add to conversation
            const conversations = JSON.parse(localStorage.getItem('worldpulse_conversations') || '[]');
            const conversationIndex = conversations.findIndex(c => c.contactId === window.currentConversation.contactId);
            
            if (conversationIndex !== -1) {
                conversations[conversationIndex].messages.push(message);
                localStorage.setItem('worldpulse_conversations', JSON.stringify(conversations));
                
                // Update the UI
                loadConversations();
                loadConversation(window.currentConversation.contactId);
                
                // Clear input
                messageInput.value = '';
            }
        }
        
        // Format time for display
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // Function to start a new conversation (called from other pages)
        function startConversation(contactId, contactName) {
            let conversations = JSON.parse(localStorage.getItem('worldpulse_conversations') || '[]');
            
            // Check if conversation already exists
            const existing = conversations.find(c => c.contactId === contactId);
            if (existing) {
                loadConversation(contactId);
                return;
            }
            
            // Create new conversation
            const newConversation = {
                contactId: contactId,
                contactName: contactName,
                messages: [],
                createdAt: new Date().toISOString(),
                lastActive: new Date().toISOString()
            };
            
            conversations.push(newConversation);
            localStorage.setItem('worldpulse_conversations', JSON.stringify(conversations));
            
            // Reload conversations and load the new one
            loadConversations();
            loadConversation(contactId);
        }
    </script>
</body>
</html>